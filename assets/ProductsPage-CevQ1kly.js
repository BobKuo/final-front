import{a$ as z,b0 as Y,a3 as G,b3 as Z,r as c,w as ee,t as ae,z as C,m as f,B as r,f as o,as as le,a8 as oe,a6 as l,ap as j,q as S,u as E,l as B,p as A,a5 as D,F as te,A as se,a7 as V,b1 as re,ar as ne,a9 as P,b2 as ie,c as J,Q as L}from"./index-B1WnD--T.js";import{c as H,Q as ue,a as $,b as de}from"./QTable-_YpDQtte.js";import{Q as me}from"./QToolbar-Be3i4fjn.js";import{Q as K}from"./QImg-BEXxzb7e.js";import{Q as ce}from"./QPage-CMc_5IbE.js";import{p as O}from"./product-CzdWWN6R.js";import{u as pe,c as ge,e as ve,a as N,f as fe,b as Q,Q as be}from"./index.esm-95upK8Dp.js";import{_ as ye}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./QList-0z79P3LI.js";import"./rtl-DFPa-2ov.js";import"./QMenu-Blwzt92N.js";import"./selection-qbrOV5jS.js";import"./QItemLabel-D-nwmFo9.js";import"./format-BvkBI9bc.js";import"./use-fullscreen-CZ3_1CEo.js";const we={class:"text-h6"},Ve={key:0,class:"row"},_e="products",he={__name:"ProductDialog",props:z({product:Object},{modelValue:{},modelModifiers:{}}),emits:z(["close"],["update:modelValue"]),setup(F,{emit:p}){const b=Y(F,"modelValue"),u=F,q=p,y=G(),_=Z("fileAgent"),M=["電子產品","服裝","家居用品","書籍","玩具","食品","其他"],{handleSubmit:T,resetForm:I,isSubmitting:d}=pe({validationSchema:ge({name:N().required("商品名稱是必填的").max(100,"商品名稱最多只能有 100 個字元"),price:fe().typeError("價格是必填的").required("價格是必填的").min(0,"價格不能為負數"),category:N().required("分類是必填的").oneOf(M,"請選擇有效的分類"),description:N().max(500,"描述最多只能有 500 個字元"),sell:ve().required("是否上架是必填的")}),initialValues:{name:"",price:0,category:"",description:"",sell:!1}}),m=Q("name"),g=Q("price"),w=Q("category"),t=Q("description"),s=Q("sell"),e=c([]),h=c([]),x=c([]),U=c([]);ee(()=>u.product,n=>{n&&(m.value.value=n.name,g.value.value=n.price,w.value.value=n.category,t.value.value=n.description,s.value.value=n.sell,x.value=[...n.images],U.value=[])});const W=T(async n=>{if(e.value.some(a=>a.error)){y.notify({type:"negative",message:"請選擇有效的圖片檔案"});return}if(!u.product&&e.value.length===0){y.dialog({title:"錯誤",message:"請上傳商品圖片"});return}if(u.product?.images.length+e?.value.length>5){y.dialog({title:"錯誤",message:`最多只能再上傳 ${5-u.product.images.length} 張圖片`});return}try{const a=new FormData;a.append("name",n.name),a.append("price",n.price),a.append("category",n.category),a.append("description",n.description),a.append("sell",n.sell),a.append("folder",_e),a.append("deletedImages",JSON.stringify(U.value)),e.value.length>0&&e.value.filter(v=>v.file).map(v=>v.file).forEach(v=>{a.append("images",v)});const{data:k}=await(u.product?O.update(u.product._id,a):O.create(a));console.log("data---",k),y.notify({type:"positive",message:u.product?"商品更新成功":"商品新增成功"}),R(k.product)}catch(a){console.error(a),y.notify({type:"negative",message:a?.response?.data?.message||"操作失敗，請稍後再試"})}}),R=n=>{I(),_.value.deleteFileRecord(),e.value=[],h.value=[],q("close",n)},X=n=>{U.value.push(x.value[n]),x.value.splice(n,1)};return(n,a)=>{const k=ae("VueFileAgent");return f(),C(ie,{modelValue:b.value,"onUpdate:modelValue":a[7]||(a[7]=i=>b.value=i),persistent:""},{default:r(()=>[o(le,{class:"q-pa-md",style:{"min-width":"400px"}},{default:r(()=>[o(be,{onSubmit:oe(l(W),["prevent"])},{default:r(()=>[o(j,null,{default:r(()=>[S("div",we,E(u.product?"編輯商品":"新增商品"),1)]),_:1}),o(j,{class:"q-gutter-md"},{default:r(()=>[o(D,{modelValue:l(m).value.value,"onUpdate:modelValue":a[0]||(a[0]=i=>l(m).value.value=i),deleteable:"",disable:l(d),error:!!l(m).errorMessage.value,"error-message":l(m).errorMessage.value,label:"名稱"},null,8,["modelValue","disable","error","error-message"]),o(D,{modelValue:l(g).value.value,"onUpdate:modelValue":a[1]||(a[1]=i=>l(g).value.value=i),disable:l(d),error:!!l(g).errorMessage.value,"error-message":l(g).errorMessage.value,label:"價格",type:"number",min:"0"},null,8,["modelValue","disable","error","error-message"]),o(H,{label:"分類",modelValue:l(w).value.value,"onUpdate:modelValue":a[2]||(a[2]=i=>l(w).value.value=i),disable:l(d),options:M,error:!!l(w).errorMessage.value,"error-message":l(w).errorMessage.value},null,8,["modelValue","disable","error","error-message"]),o(D,{modelValue:l(t).value.value,"onUpdate:modelValue":a[3]||(a[3]=i=>l(t).value.value=i),disable:l(d),error:!!l(t).errorMessage.value,"error-message":l(t).errorMessage.value,label:"描述",type:"textarea",outlined:""},null,8,["modelValue","disable","error","error-message"]),x.value.length>0?(f(),B("div",Ve,[(f(!0),B(te,null,se(x.value,(i,v)=>(f(),B("div",{key:v,class:"image-container",style:{position:"relative",width:"20%"}},[o(K,{src:i,style:{width:"100%"},alt:i},null,8,["src","alt"]),o(V,{round:"",dense:"",icon:"close",color:"negative",class:"delete-btn",size:"8px",onClick:ke=>X(v)},null,8,["onClick"])]))),128))])):A("",!0),o(k,{ref_key:"fileAgent",ref:_,modelValue:e.value,"onUpdate:modelValue":a[4]||(a[4]=i=>e.value=i),"raw-model-value":h.value,"onUpdate:rawModelValue":a[5]||(a[5]=i=>h.value=i),accept:"image/jpeg,image/png",deletable:"",disable:l(d),"error-text":{type:"檔案格式不正確",size:"檔案大小不得超過 1MB"},"help-text":"選擇或拖拽檔案",multiple:!0,maxFiles:5,"max-size":"5MB"},null,8,["modelValue","raw-model-value","disable"]),o(re,{label:l(s).value.value?"上架中":"未上架",modelValue:l(s).value.value,"onUpdate:modelValue":a[6]||(a[6]=i=>l(s).value.value=i),disable:l(d),error:!!l(s).errorMessage.value,"error-message":l(s).errorMessage.value},null,8,["label","modelValue","disable","error","error-message"]),o(ne,{align:"right"},{default:r(()=>[o(V,{color:"secondary",onClick:R},{default:r(()=>a[8]||(a[8]=[P("取消",-1)])),_:1,__:[8]}),o(V,{type:"submit",loading:l(d),color:"primary"},{default:r(()=>[P(E(u.product?"更新":"新增"),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1},8,["modelValue"])}}},xe=ye(he,[["__scopeId","data-v-f0e97a02"]]),Qe={style:{"overflow-x":"auto","max-width":"100%"}},Ce={style:{display:"flex","align-items":"center",gap:"8px"}},Me={style:{width:"200px",height:"100px","overflow-y":"scroll","white-space":"pre-line"}},ze={__name:"ProductsPage",setup(F){const p=c([]),b=c(""),u=c(null),q=J(()=>[...new Set(p.value.map(s=>s.category))].map(s=>({label:s,value:s}))),y=J(()=>p.value.filter(t=>{const s=!b.value||t.name.toLowerCase().includes(b.value.toLowerCase()),e=!u.value||t.category.toLowerCase().includes(u.value.toLowerCase());return s&&e})),_=G(),M=[{name:"_id",label:"ID",field:"_id"},{name:"images",label:"圖片",field:"images",align:"center",sortable:!1},{name:"name",label:"名稱",field:"name",sortable:!0},{name:"category",label:"分類",field:"category"},{name:"price",label:"價格",field:"price",align:"right",sortable:!0},{name:"description",label:"描述",field:"description"},{name:"sell",label:"上架",field:"sell"},{name:"createdAt",label:"建立日期",field:t=>new Date(t.createdAt).toLocaleString(),sortable:!0},{name:"updatedAt",label:"更新日期",field:t=>new Date(t.updatedAt).toLocaleString(),sortable:!0},{name:"action",label:"操作",field:"action"}];(async()=>{try{const{data:t}=await O.getAll();p.value=t.products}catch(t){console.error("Error fetching products:",t),_.notify({type:"negative",message:"無法載入商品資料"})}})();const I=t=>{_.dialog({title:"所有圖片",message:t.map(s=>`<img src="${s}" style="width: 100%; margin-bottom: 8px;" />`).join(""),html:!0})},d=c(!1),m=c(null),g=t=>{m.value=t,d.value=!0},w=t=>{if(t){const s=p.value.findIndex(e=>e._id===t._id);s!==-1?p.value[s]=t:p.value.push(t)}d.value=!1,m.value=null};return(t,s)=>(f(),C(ce,{class:"flex flex-center"},{default:r(()=>[S("div",Qe,[o(ue,{separator:"cell",rows:y.value,columns:M,"row-key":"id",class:"q-table--dense",pagination:{rowsPerPage:10}},{top:r(()=>[o(me,null,{default:r(()=>[o(V,{flat:"",icon:"add",label:"新增商品",onClick:s[0]||(s[0]=e=>g(null)),class:"q-mr-sm"}),o(de),o(D,{modelValue:b.value,"onUpdate:modelValue":s[1]||(s[1]=e=>b.value=e),dense:"",outlined:"",clearable:"",placeholder:"搜尋名稱"},{prepend:r(()=>[o(L,{name:"search"})]),_:1},8,["modelValue"]),o(H,{modelValue:u.value,"onUpdate:modelValue":s[2]||(s[2]=e=>u.value=e),dense:"",outlined:"",clearable:"",placeholder:"搜尋分類",options:q.value,"emit-value":"","map-options":""},{prepend:r(()=>[o(L,{name:"filter_list"})]),_:1},8,["modelValue","options"])]),_:1})]),"body-cell-images":r(e=>[o($,{props:e},{default:r(()=>[S("div",Ce,[e.row.images&&e.row.images.length>0?(f(),C(K,{key:0,src:e.row.images[0],style:{width:"100px",height:"100px"},class:"q-ma-sm",alt:e.row.name},null,8,["src","alt"])):A("",!0),e.row.images.length>1?(f(),C(V,{key:1,outline:"",dense:"",label:"更多",onClick:h=>I(e.row.images)},null,8,["onClick"])):A("",!0)])]),_:2},1032,["props"])]),"body-cell-description":r(e=>[o($,{props:e},{default:r(()=>[S("div",Me,E(e.row.description),1)]),_:2},1032,["props"])]),"body-cell-sell":r(e=>[o($,{props:e},{default:r(()=>[e.row.sell?(f(),C(L,{key:0,name:"check",color:"green"})):A("",!0)]),_:2},1032,["props"])]),"body-cell-action":r(e=>[o($,{props:e},{default:r(()=>[o(V,{flat:"",icon:"edit",onClick:h=>g(e.row)},null,8,["onClick"])]),_:2},1032,["props"])]),_:1},8,["rows"])]),o(xe,{modelValue:d.value,"onUpdate:modelValue":s[3]||(s[3]=e=>d.value=e),product:m.value,onClose:w},null,8,["modelValue","product"])]),_:1}))}};export{ze as default};
