import{a$ as U,b0 as K,a3 as O,r as m,w as L,z as _,m as u,B as a,f as e,as as X,ap as B,q as A,l as x,F as N,A as P,a9 as C,u as D,b5 as ie,ar as Y,a7 as Q,b2 as Z,b3 as ue,t as de,a8 as me,a6 as r,p as S,a5 as E,b1 as ce,c as pe,Q as J}from"./index-DZ7e7Z0X.js";import{Q as ve,a as $,b as fe}from"./QTable-pQK5kev2.js";import{Q as ge}from"./QToolbar-CIGC3H3E.js";import{Q as ee}from"./QImg-B42X8Bei.js";import{Q as G}from"./QBadge-DLZMpN7q.js";import{Q as ye}from"./QPage-Cm13AEX4.js";import{w as be,s as R}from"./series-Bwf_h1HJ.js";import{Q as le,a as ae,b as W}from"./QList-H1D4SlK6.js";import{Q as te}from"./QItemLabel-Dov7KhOd.js";import{u as _e,c as we,e as Ve,a as H,b as z,Q as ke}from"./index.esm-C-jwnzVm.js";import{_ as xe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./rtl-DFPa-2ov.js";import"./QMenu-BRzuh4sS.js";import"./selection-mnkafmr5.js";import"./format-BvkBI9bc.js";import"./use-fullscreen-wjppR2xo.js";const Qe={__name:"WorklistDialog",props:U({works:Array,seriesId:String},{modelValue:{},modelModifiers:{}}),emits:U(["close"],["update:modelValue"]),setup(M,{emit:y}){const c=K(M,"modelValue"),d=M,h=y,w=O(),q=m([]),f=m([]),V=async o=>{try{console.log("獲取作品簡單列表");const{data:t}=await be.getList(o);q.value=t.works}catch(t){console.error("Error fetching works:",t),w.notify({type:"negative",message:"無法載入作品簡單列表"})}};L(()=>d.works,o=>{o&&(V(d.seriesId),f.value=d.works)},{immediate:!0});const p=o=>{const t=f.value.indexOf(o._id);t===-1?f.value.push(o._id):f.value.splice(t,1)},g=o=>{f.value=[],h("close",o)},b=()=>{g(f.value)};return(o,t)=>(u(),_(Z,{modelValue:c.value,"onUpdate:modelValue":t[1]||(t[1]=l=>c.value=l),persistent:""},{default:a(()=>[e(X,{class:"q-pa-md",style:{"min-width":"400px"}},{default:a(()=>[e(B,null,{default:a(()=>t[2]||(t[2]=[A("div",{class:"text-h6"},"選擇代表作品",-1)])),_:1,__:[2]}),e(B,{class:"q-gutter-md"},{default:a(()=>[e(le,{bordered:"",separator:""},{default:a(()=>[(u(!0),x(N,null,P(q.value,l=>(u(),_(ae,{key:l._id,onClick:v=>p(l)},{default:a(()=>[e(W,null,{default:a(()=>[e(te,null,{default:a(()=>[C(D(l.title),1)]),_:2},1024)]),_:2},1024),e(W,{side:""},{default:a(()=>[e(ie,{modelValue:f.value,"onUpdate:modelValue":t[0]||(t[0]=v=>f.value=v),"true-value":l._id,"false-value":null},null,8,["modelValue","true-value"])]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1}),e(Y,{align:"right"},{default:a(()=>[e(Q,{color:"secondary",onClick:g},{default:a(()=>t[3]||(t[3]=[C("取消",-1)])),_:1,__:[3]}),e(Q,{color:"primary",onClick:b},{default:a(()=>t[4]||(t[4]=[C("確定",-1)])),_:1,__:[4]})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},Ce={class:"text-h6"},he=["src"],qe={key:1,class:"image-container",style:{position:"relative",width:"100%"}},De="series",Me={__name:"SeriesDialog",props:U({series:Object},{modelValue:{},modelModifiers:{}}),emits:U(["close"],["update:modelValue"]),setup(M,{emit:y}){const c=K(M,"modelValue"),d=M,h=y,w=O(),q=ue("fileAgent"),{handleSubmit:f,resetForm:V,isSubmitting:p}=_e({validationSchema:we({name:H().required("系列名稱是必填的").max(10,"作品標題最多只能有 10 個字元"),description:H().max(100,"描述最多只能有 100 個字元"),post:Ve().required("是否上首頁是必填的")}),initialValues:{name:"",description:"",post:!1}}),g=z("name"),b=z("description"),o=z("post"),t=m([]),l=m([]),v=m([]),k=m(""),F=m("");L(c,i=>{i&&!d.work&&(t.value=[],k.value="",F.value="")}),L(()=>d.series,i=>{i&&(g.value.value=i.name,b.value.value=i.description,o.value.value=i.post,t.value=i.works,k.value=i.cover,F.value="")});const oe=f(async i=>{if(l.value[0]?.error){w.notify({type:"negative",message:"請選擇有效的圖片檔案"});return}if(k.value&&l.value.length>0){w.dialog({title:"錯誤",message:"請先刪除原來的封面圖片，才能上傳新圖片"});return}try{const s=new FormData;s.append("name",i.name),s.append("works",JSON.stringify(t.value)),s.append("description",i.description),s.append("post",i.post),s.append("folder",De),s.append("deletedImage",F.value),l.value.length>0&&s.append("image",l.value[0].file);const{data:T}=await(d.series?R.update(d.series._id,s):R.create(s));w.notify({type:"positive",message:d.series?"系列更新成功":"系列新增成功"}),j(T.series)}catch(s){console.error(s),w.notify({type:"negative",message:s?.response?.data?.message||"操作失敗，請稍後再試"})}}),j=i=>{V(),q.value.deleteFileRecord(),l.value=[],v.value=[],h("close",i)},se=()=>{F.value=k.value,k.value=""},I=m(!1),re=()=>{I.value=!0},ne=i=>{I.value=!1,t.value=i};return(i,s)=>{const T=de("VueFileAgent");return u(),_(Z,{modelValue:c.value,"onUpdate:modelValue":s[7]||(s[7]=n=>c.value=n),persistent:""},{default:a(()=>[e(X,{class:"q-pa-md",style:{"min-width":"400px"}},{default:a(()=>[e(ke,{onSubmit:me(r(oe),["prevent"])},{default:a(()=>[e(B,null,{default:a(()=>[A("div",Ce,D(d.series?"編輯系列":"新增系列"),1)]),_:1}),e(B,{class:"q-gutter-md"},{default:a(()=>[e(E,{modelValue:r(g).value.value,"onUpdate:modelValue":s[0]||(s[0]=n=>r(g).value.value=n),deleteable:"",disable:r(p),error:!!r(g).errorMessage.value,"error-message":r(g).errorMessage.value,label:"系列名稱",maxlength:"10",counter:""},null,8,["modelValue","disable","error","error-message"]),e(Q,{outline:"",color:"primary",label:"選擇代表作品",onClick:re,disable:r(p)},null,8,["disable"]),t.value.length>0?(u(),_(le,{key:0,bordered:"",separator:"",class:"q-pa-sm"},{default:a(()=>[(u(!0),x(N,null,P(t.value,n=>(u(),_(ae,{key:n._id},{default:a(()=>[e(W,{top:"",thumbnail:"",class:"q-ml-none"},{default:a(()=>[A("img",{src:n.images[0]},null,8,he)]),_:2},1024),e(W,null,{default:a(()=>[e(te,null,{default:a(()=>[C(D(n.title),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):S("",!0),e(E,{modelValue:r(b).value.value,"onUpdate:modelValue":s[1]||(s[1]=n=>r(b).value.value=n),disable:r(p),error:!!r(b).errorMessage.value,"error-message":r(b).errorMessage.value,label:"描述",type:"textarea",outlined:"",maxlength:"100",counter:""},null,8,["modelValue","disable","error","error-message"]),s[9]||(s[9]=A("div",{class:"text-overline text-grey-7"},"系列封面",-1)),k.value?(u(),x("div",qe,[e(ee,{src:k.value,style:{width:"100%"},alt:k.value},null,8,["src","alt"]),e(Q,{round:"",dense:"",icon:"close",color:"negative",class:"delete-btn",size:"8px",onClick:se})])):S("",!0),e(T,{ref_key:"fileAgent",ref:q,modelValue:l.value,"onUpdate:modelValue":s[2]||(s[2]=n=>l.value=n),"raw-model-value":v.value,"onUpdate:rawModelValue":s[3]||(s[3]=n=>v.value=n),accept:"image/jpeg,image/png",deletable:"",disable:r(p),"error-text":{type:"檔案格式不正確",size:"檔案大小不得超過 5MB"},"help-text":"選擇或拖拽檔案","max-size":"5MB"},null,8,["modelValue","raw-model-value","disable"]),e(ce,{label:r(o).value.value?"已上首頁":"上首頁",modelValue:r(o).value.value,"onUpdate:modelValue":s[4]||(s[4]=n=>r(o).value.value=n),disable:r(p),error:!!r(o).errorMessage.value,"error-message":r(o).errorMessage.value},null,8,["label","modelValue","disable","error","error-message"]),e(Y,{align:"right"},{default:a(()=>[e(Q,{color:"secondary",onClick:s[5]||(s[5]=n=>j(!1))},{default:a(()=>s[8]||(s[8]=[C("取消",-1)])),_:1,__:[8]}),e(Q,{type:"submit",loading:r(p),color:"primary"},{default:a(()=>[C(D(d.series?"更新":"新增"),1)]),_:1},8,["loading"])]),_:1})]),_:1,__:[9]})]),_:1},8,["onSubmit"])]),_:1}),e(Qe,{modelValue:I.value,"onUpdate:modelValue":s[6]||(s[6]=n=>I.value=n),works:t.value,"series-id":d.series._id,onClose:ne},null,8,["modelValue","works","series-id"])]),_:1},8,["modelValue"])}}},Se=xe(Me,[["__scopeId","data-v-ae15664c"]]),$e={style:{"overflow-x":"auto","max-width":"100%"}},Ae={key:0,style:{display:"flex","align-items":"center",gap:"8px"}},Fe={key:0,class:"row q-gutter-xs",style:{width:"150px"}},Ie={key:0,style:{width:"200px",height:"100px","overflow-y":"auto","white-space":"pre-line"}},Xe={__name:"SeriesPage",setup(M){const y=m([]),c=m(""),d=pe(()=>y.value.filter(o=>!c.value||o.name.toLowerCase().includes(c.value.toLowerCase()))),h=m({page:1,rowsPerPage:5});L(c,()=>{h.value.page=1});const w=O(),q=[{name:"action",label:"操作",field:"action"},{name:"post",label:"上首頁",field:"post"},{name:"name",label:"名稱",field:"name",align:"left",sortable:!0},{name:"cover",label:"封面",field:"cover",align:"center",sortable:!1},{name:"works",label:"代表作品",field:o=>o.works.join(", "),align:"left"},{name:"description",label:"描述",field:"description"},{name:"createdAt",label:"建立日期",field:o=>new Date(o.createdAt).toLocaleString(),sortable:!0},{name:"updatedAt",label:"更新日期",field:o=>new Date(o.updatedAt).toLocaleString(),sortable:!0}];(async()=>{try{console.log("獲取系列列表");const{data:o}=await R.getAll();y.value=o.series}catch(o){console.error("Error fetching series:",o),w.notify({type:"negative",message:"無法載入系列資料"})}})();const V=m(!1),p=m(null),g=o=>{p.value=o,V.value=!0},b=o=>{if(o){const t=y.value.findIndex(l=>l._id===o._id);t!==-1?y.value[t]=o:y.value.push(o)}V.value=!1,p.value=null};return(o,t)=>(u(),_(ye,{class:"flex flex-center"},{default:a(()=>[A("div",$e,[e(ve,{separator:"cell",rows:d.value,columns:q,"row-key":"id",class:"q-table--dense",pagination:h.value,"onUpdate:pagination":t[2]||(t[2]=l=>h.value=l),style:{width:"80vw"}},{top:a(()=>[e(ge,null,{default:a(()=>[e(Q,{flat:"",icon:"add",label:"新增系列",onClick:t[0]||(t[0]=l=>g(null)),class:"q-mr-sm"}),e(fe),e(E,{modelValue:c.value,"onUpdate:modelValue":t[1]||(t[1]=l=>c.value=l),dense:"",outlined:"",clearable:"",placeholder:"搜尋名稱"},{prepend:a(()=>[e(J,{name:"search"})]),_:1},8,["modelValue"])]),_:1})]),"body-cell-cover":a(l=>[e($,{props:l,style:{width:"30%"}},{default:a(()=>[l.row.cover?(u(),x("div",Ae,[e(ee,{src:l.row.cover,style:{width:"100%",height:"100%"},class:"q-ma-sm",alt:l.row.name,fit:"contain"},null,8,["src","alt"])])):S("",!0)]),_:2},1032,["props"])]),"body-cell-works":a(l=>[e($,{props:l},{default:a(()=>[l.row.works.length>0?(u(),x("div",Fe,[(u(!0),x(N,null,P(l.row.works,v=>(u(),x(N,{key:v._id},[v.enable?(u(),_(G,{key:0,color:"primary",class:"q-mr-xs"},{default:a(()=>[C(D(v.name),1)]),_:2},1024)):(u(),_(G,{key:1,color:"grey",style:{"text-decoration":"line-through"},class:"q-mr-xs",outline:""},{default:a(()=>[C(D(v.name),1)]),_:2},1024))],64))),128))])):S("",!0)]),_:2},1032,["props"])]),"body-cell-description":a(l=>[e($,{props:l},{default:a(()=>[l.row.description?(u(),x("div",Ie,D(l.row.description),1)):S("",!0)]),_:2},1032,["props"])]),"body-cell-post":a(l=>[e($,{props:l},{default:a(()=>[l.row.post?(u(),_(J,{key:0,name:"check",size:"md",color:"green"})):S("",!0)]),_:2},1032,["props"])]),"body-cell-action":a(l=>[e($,{props:l},{default:a(()=>[e(Q,{flat:"",icon:"edit",onClick:v=>g(l.row)},null,8,["onClick"])]),_:2},1032,["props"])]),_:1},8,["rows","pagination"])]),e(Se,{modelValue:V.value,"onUpdate:modelValue":t[3]||(t[3]=l=>V.value=l),series:p.value,onClose:b},null,8,["modelValue","series"])]),_:1}))}};export{Xe as default};
