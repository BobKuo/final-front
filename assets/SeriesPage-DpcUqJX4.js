import{a$ as E,b0 as le,a3 as G,b3 as se,r as u,w as B,t as te,z as w,m as d,B as s,f as a,as as oe,a8 as re,a6 as o,ap as P,q as C,u as Q,p as D,l as M,a5 as U,a7 as V,F as N,A as H,a9 as q,b1 as ne,ar as ie,b2 as ue,c as de,Q as j}from"./index-BQ2YKjMm.js";import{Q as me,a as k,b as ce}from"./QTable-DdkEevjO.js";import{Q as pe}from"./QToolbar-9Xcf0hQe.js";import{Q as K}from"./QImg-YftB_vO6.js";import{Q as O}from"./QBadge-CoeZMmg8.js";import{Q as ve}from"./QPage-Ds2PIG3P.js";import{s as T}from"./series-DlVpj7Gt.js";import{Q as ge,a as fe,b as W}from"./QList-Dkm9Qkso.js";import{Q as be}from"./QItemLabel-d2rr-Oo_.js";import{u as ye,c as we,e as _e,a as J,b as I,Q as xe}from"./index.esm-DNu86ctf.js";import{_ as Ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./rtl-DFPa-2ov.js";import"./QMenu-tgfM3IF2.js";import"./selection-Cnnv7yoK.js";import"./format-BvkBI9bc.js";import"./use-fullscreen-DN0Wah6S.js";const Qe={class:"text-h6"},he=["src"],ke={key:1,class:"image-container",style:{position:"relative",width:"20%"}},Ce="series",Me={__name:"SeriesDialog",props:E({series:Object},{modelValue:{},modelModifiers:{}}),emits:E(["close"],["update:modelValue"]),setup($,{emit:b}){const c=le($,"modelValue"),p=$,h=b,_=G(),S=se("fileAgent"),{handleSubmit:z,resetForm:x,isSubmitting:m}=ye({validationSchema:we({name:J().required("系列名稱是必填的").max(10,"作品標題最多只能有 10 個字元"),description:J().max(100,"描述最多只能有 100 個字元"),post:_e().required("是否上首頁是必填的")}),initialValues:{name:"",description:"",post:!1}}),g=I("name"),y=I("description"),t=I("post"),i=u([]),e=u([]),v=u([]),f=u(""),A=u("");u([]),u([]);const F=u([]);B(c,r=>{console.log("model變化",r),r&&!p.work&&(i.value=[],f.value="",A.value="",R())}),B(()=>p.series,r=>{r&&(g.value.value=r.name,y.value.value=r.description,t.value.value=r.post,f.value=r.cover,A.value="",R())});const X=z(async r=>{if(e.value[0]?.error){_.notify({type:"negative",message:"請選擇有效的圖片檔案"});return}if(f.value){_.dialog({title:"錯誤",message:"請先刪除原來的封面圖片，才能上傳新圖片"});return}try{const l=new FormData;l.append("name",r.name),l.append("works",JSON.stringify(F.value)),l.append("description",r.description),l.append("post",r.post),l.append("folder",Ce),l.append("deletedImage",A.value),e.value.length>0&&l.append("image",e.value[0].file);const{data:L}=await(p.series?T.update(p.series._id,l):T.create(l));_.notify({type:"positive",message:p.series?"系列更新成功":"系列新增成功"}),Y(L.series)}catch(l){console.error(l),_.notify({type:"negative",message:l?.response?.data?.message||"操作失敗，請稍後再試"})}}),Y=r=>{x(),S.value.deleteFileRecord(),e.value=[],v.value=[],h("close",r)},Z=()=>{A.value=f.value,f.value=""},R=async()=>{},ee=u(!1),ae=()=>{ee.value=!0};return(r,l)=>{const L=te("VueFileAgent");return d(),w(ue,{modelValue:c.value,"onUpdate:modelValue":l[6]||(l[6]=n=>c.value=n),persistent:""},{default:s(()=>[a(oe,{class:"q-pa-md",style:{"min-width":"400px"}},{default:s(()=>[a(xe,{onSubmit:re(o(X),["prevent"])},{default:s(()=>[a(P,null,{default:s(()=>[C("div",Qe,Q(p.series?"編輯系列":"新增系列"),1)]),_:1}),a(P,{class:"q-gutter-md"},{default:s(()=>[a(U,{modelValue:o(g).value.value,"onUpdate:modelValue":l[0]||(l[0]=n=>o(g).value.value=n),deleteable:"",disable:o(m),error:!!o(g).errorMessage.value,"error-message":o(g).errorMessage.value,label:"系列名稱",maxlength:"10",counter:""},null,8,["modelValue","disable","error","error-message"]),a(V,{outline:"",color:"primary",label:"選擇作品",onClick:ae,disable:o(m)},null,8,["disable"]),F.value.length>0?(d(),w(ge,{key:0,bordered:"",separator:"",class:"q-pa-sm"},{default:s(()=>[(d(!0),M(N,null,H(F.value,n=>(d(),w(fe,{key:n._id},{default:s(()=>[a(W,{top:"",thumbnail:"",class:"q-ml-none"},{default:s(()=>[C("img",{src:n.images[0]},null,8,he)]),_:2},1024),a(W,null,{default:s(()=>[a(be,null,{default:s(()=>[q(Q(n.title),1)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):D("",!0),a(U,{modelValue:o(y).value.value,"onUpdate:modelValue":l[1]||(l[1]=n=>o(y).value.value=n),disable:o(m),error:!!o(y).errorMessage.value,"error-message":o(y).errorMessage.value,label:"描述",type:"textarea",outlined:"",maxlength:"100",counter:""},null,8,["modelValue","disable","error","error-message"]),f.value?(d(),M("div",ke,[a(K,{src:f.value,style:{width:"100%"},alt:f.value},null,8,["src","alt"]),a(V,{round:"",dense:"",icon:"close",color:"negative",class:"delete-btn",size:"8px",onClick:Z})])):D("",!0),a(L,{ref_key:"fileAgent",ref:S,modelValue:e.value,"onUpdate:modelValue":l[2]||(l[2]=n=>e.value=n),"raw-model-value":v.value,"onUpdate:rawModelValue":l[3]||(l[3]=n=>v.value=n),accept:"image/jpeg,image/png",deletable:"",disable:o(m),"error-text":{type:"檔案格式不正確",size:"檔案大小不得超過 5MB"},"help-text":"選擇或拖拽檔案","max-size":"5MB"},null,8,["modelValue","raw-model-value","disable"]),a(ne,{label:o(t).value.value?"上首頁":"不上首頁",modelValue:o(t).value.value,"onUpdate:modelValue":l[4]||(l[4]=n=>o(t).value.value=n),disable:o(m),error:!!o(t).errorMessage.value,"error-message":o(t).errorMessage.value},null,8,["label","modelValue","disable","error","error-message"]),a(ie,{align:"right"},{default:s(()=>[a(V,{color:"secondary",onClick:l[5]||(l[5]=n=>r.closeList(!1))},{default:s(()=>l[7]||(l[7]=[q("取消",-1)])),_:1,__:[7]}),a(V,{type:"submit",loading:o(m),color:"primary"},{default:s(()=>[q(Q(p.series?"更新":"新增"),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1},8,["modelValue"])}}},qe=Ve(Me,[["__scopeId","data-v-edc01360"]]),Se={style:{"overflow-x":"auto","max-width":"100%"}},Ae={style:{display:"flex","align-items":"center",gap:"8px"}},De={key:0,class:"row q-gutter-xs",style:{width:"150px"}},$e={style:{width:"200px",height:"100px","overflow-y":"auto","white-space":"pre-line"}},He={__name:"SeriesPage",setup($){const b=u([]),c=u(""),p=de(()=>b.value.filter(t=>!c.value||t.name.toLowerCase().includes(c.value.toLowerCase()))),h=u({page:1,rowsPerPage:5});B(c,()=>{h.value.page=1});const _=G(),S=[{name:"action",label:"操作",field:"action"},{name:"post",label:"上首頁",field:"post"},{name:"name",label:"名稱",field:"name",align:"left",sortable:!0},{name:"cover",label:"封面",field:"cover",align:"center",sortable:!1},{name:"works",label:"代表作品",field:t=>t.works.join(", "),align:"left"},{name:"description",label:"描述",field:"description"},{name:"createdAt",label:"建立日期",field:t=>new Date(t.createdAt).toLocaleString(),sortable:!0},{name:"updatedAt",label:"更新日期",field:t=>new Date(t.updatedAt).toLocaleString(),sortable:!0}];(async()=>{try{console.log("獲取系列列表");const{data:t}=await T.getAll();b.value=t.series}catch(t){console.error("Error fetching series:",t),_.notify({type:"negative",message:"無法載入系列資料"})}})();const x=u(!1),m=u(null),g=t=>{m.value=t,x.value=!0},y=t=>{if(t){const i=b.value.findIndex(e=>e._id===t._id);i!==-1?b.value[i]=t:b.value.push(t)}x.value=!1,m.value=null};return(t,i)=>(d(),w(ve,{class:"flex flex-center"},{default:s(()=>[C("div",Se,[a(me,{separator:"cell",rows:p.value,columns:S,"row-key":"id",class:"q-table--dense",pagination:h.value,"onUpdate:pagination":i[2]||(i[2]=e=>h.value=e)},{top:s(()=>[a(pe,null,{default:s(()=>[a(V,{flat:"",icon:"add",label:"新增系列",onClick:i[0]||(i[0]=e=>g(null)),class:"q-mr-sm"}),a(ce),a(U,{modelValue:c.value,"onUpdate:modelValue":i[1]||(i[1]=e=>c.value=e),dense:"",outlined:"",clearable:"",placeholder:"搜尋名稱"},{prepend:s(()=>[a(j,{name:"search"})]),_:1},8,["modelValue"])]),_:1})]),"body-cell-cover":s(e=>[a(k,{props:e},{default:s(()=>[C("div",Ae,[a(K,{src:e.row.cover,style:{width:"100px",height:"100px"},class:"q-ma-sm",alt:e.row.name},null,8,["src","alt"])])]),_:2},1032,["props"])]),"body-cell-works":s(e=>[a(k,{props:e},{default:s(()=>[e.row.works.length>0?(d(),M("div",De,[(d(!0),M(N,null,H(e.row.works,v=>(d(),M(N,{key:v._id},[v.enable?(d(),w(O,{key:0,color:"primary",class:"q-mr-xs"},{default:s(()=>[q(Q(v.name),1)]),_:2},1024)):(d(),w(O,{key:1,color:"grey",style:{"text-decoration":"line-through"},class:"q-mr-xs",outline:""},{default:s(()=>[q(Q(v.name),1)]),_:2},1024))],64))),128))])):D("",!0)]),_:2},1032,["props"])]),"body-cell-description":s(e=>[a(k,{props:e},{default:s(()=>[C("div",$e,Q(e.row.description),1)]),_:2},1032,["props"])]),"body-cell-post":s(e=>[a(k,{props:e},{default:s(()=>[e.row.post?(d(),w(j,{key:0,name:"check",size:"md",color:"green"})):D("",!0)]),_:2},1032,["props"])]),"body-cell-action":s(e=>[a(k,{props:e},{default:s(()=>[a(V,{flat:"",icon:"edit",onClick:v=>g(e.row)},null,8,["onClick"])]),_:2},1032,["props"])]),_:1},8,["rows","pagination"])]),a(qe,{modelValue:x.value,"onUpdate:modelValue":i[3]||(i[3]=e=>x.value=e),series:m.value,onClose:y},null,8,["modelValue","series"])]),_:1}))}};export{He as default};
