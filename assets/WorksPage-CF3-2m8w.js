import{a_ as q,a$ as P,b0 as se,a3 as W,r as v,w as J,z as C,m as p,B as a,f as l,as as ne,ap as O,q as w,a5 as z,v as ae,a7 as V,Q as K,l as $,F as G,A as ee,u as A,b1 as re,ar as ie,a9 as F,b2 as ue,b3 as ye,t as be,a8 as we,a6 as d,p as E,b4 as ke,c as Ve}from"./index-B1WnD--T.js";import{c as de,Q as _e,a as T,b as xe}from"./QTable-_YpDQtte.js";import{Q as he}from"./QToolbar-Be3i4fjn.js";import{Q as me}from"./QImg-BEXxzb7e.js";import{Q as te}from"./QBadge-rpwwO9LI.js";import{Q as Qe}from"./QPage-CMc_5IbE.js";import{s as Ce}from"./series-DgJ8ybdz.js";import{u as $e,c as Ae,e as qe,a as Y,b as R,Q as Se}from"./index.esm-95upK8Dp.js";import{Q as De,a as Me,b as oe}from"./QList-0z79P3LI.js";import{_ as Ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./rtl-DFPa-2ov.js";import"./QMenu-Blwzt92N.js";import"./selection-qbrOV5jS.js";import"./QItemLabel-D-nwmFo9.js";import"./format-BvkBI9bc.js";import"./use-fullscreen-CZ3_1CEo.js";const Z={create(g){return q.apiAuth.post("/work/add",g)},getAll(){return q.apiAuth.get("/work/all")},get(){return q.api.get("/work")},getId(g){return q.api.get("/work/"+g)},update(g,S){return q.apiAuth.patch(`/work/${g}`,S)}},ce={create(g){return q.apiAuth.post("/tag/add",g)},getAll(){return q.apiAuth.get("/tag/all")},update(g){return q.apiAuth.post("/tag/update",g)},delete(g){return q.apiAuth.post("/tag/delete",{name:g})}},Ne={key:0,class:"row"},Te={class:"row q-gutter-sm"},Fe={__name:"TagDialog",props:P({tags:Array},{modelValue:{},modelModifiers:{}}),emits:P(["close"],["update:modelValue"]),setup(g,{emit:S}){const y=se(g,"modelValue"),c=g,D=S,k=W(),b=v(""),f=v([]);J(y,n=>{n&&(console.log("Tag 對話框已開啟，執行初始化邏輯"),f.value=c.tags.map(o=>({label:o.name,value:o._id,enable:o.enable,isEditing:!1,newName:o.name})),console.log("初始化標籤選項:",f.value))},{immediate:!0});const U=()=>{if(!b.value.trim()){k.notify({type:"negative",message:"標籤名稱不能為空"});return}if(f.value.some(n=>n.label===b.value.trim())){k.notify({type:"negative",message:"標籤已存在"});return}f.value.push({label:b.value.trim(),value:b.value.trim(),enable:!0}),b.value=""},h=n=>{if(n<0||n>=f.value.length){console.error("無效的標籤索引:",n);return}f.value.splice(n,1)},_=n=>{if(!n.newName.trim()){n.isEditing=!1;return}if(f.value.some(o=>o.label===n.newName.trim()&&o.value!==n.value)){k.notify({type:"negative",message:"標籤已存在"});return}if(n.newName.trim()===n.label){n.isEditing=!1;return}n.label=n.newName.trim(),n.isEditing=!1},Q=async n=>{if(n)try{const o=f.value.map(i=>({_id:i.value,name:i.label,type:"插畫作品",enable:i.enable}));console.log("提交標籤更新:",o),await ce.update(o),k.notify({type:"positive",message:"標籤更新成功"})}catch(o){console.error("更新標籤時發生錯誤: ",o),k.notify({type:"negative",message:"無法更新標籤"})}b.value="",D("close")};return(n,o)=>(p(),C(ue,{modelValue:y.value,"onUpdate:modelValue":o[3]||(o[3]=i=>y.value=i),persistent:""},{default:a(()=>[l(ne,{class:"q-pa-md",style:{"min-width":"400px"}},{default:a(()=>[l(O,null,{default:a(()=>o[4]||(o[4]=[w("div",{class:"text-h6"},"管理標籤",-1)])),_:1,__:[4]}),l(O,null,{default:a(()=>[l(z,{"bottom-slots":"",modelValue:b.value,"onUpdate:modelValue":o[0]||(o[0]=i=>b.value=i),label:"新增標籤",clearable:"",counter:"",outlined:"",maxlength:"10",onKeyup:ae(U,["enter"])},{before:a(()=>[l(K,{name:"label"})]),hint:a(()=>o[5]||(o[5]=[])),append:a(()=>[l(V,{round:"",dense:"",flat:"",icon:"add",onClick:U})]),_:1},8,["modelValue"])]),_:1}),l(O,null,{default:a(()=>[l(De,null,{default:a(()=>[(p(!0),$(G,null,ee(f.value,(i,N)=>(p(),C(Me,{key:i.value},{default:a(()=>[l(oe,null,{default:a(()=>[i.isEditing?(p(),C(z,{key:1,modelValue:i.newName,"onUpdate:modelValue":s=>i.newName=s,dense:"",outlined:"",autofocus:"",onBlur:s=>_(i),onKeyup:ae(s=>_(i),["enter"])},null,8,["modelValue","onUpdate:modelValue","onBlur","onKeyup"])):(p(),$("div",Ne,[l(V,{size:"sm",dense:"",flat:"",icon:"edit",onClick:s=>i.isEditing=!0,class:"q-mr-sm"},null,8,["onClick"]),w("span",null,A(i.label),1)]))]),_:2},1024),l(oe,{side:""},{default:a(()=>[w("div",Te,[l(re,{dense:"",class:"q-pa-sm",style:{border:"1px solid #ccc"},modelValue:i.enable,"onUpdate:modelValue":s=>i.enable=s,label:"啟用"},null,8,["modelValue","onUpdate:modelValue"]),l(V,{size:"sm",outline:"",dense:"",icon:"delete",onClick:s=>h(N)},null,8,["onClick"])])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),l(ie,{align:"right"},{default:a(()=>[l(V,{color:"secondary",onClick:o[1]||(o[1]=i=>Q(!1))},{default:a(()=>o[6]||(o[6]=[F("取消",-1)])),_:1,__:[6]}),l(V,{color:"primary",onClick:o[2]||(o[2]=i=>Q(!0))},{default:a(()=>o[7]||(o[7]=[F("儲存",-1)])),_:1,__:[7]})]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},Ie={class:"text-h6"},Be={style:{border:"1px solid #aaa","border-radius":"4px",padding:"8px"}},Ee={class:"row justify-between"},Oe={key:0,class:"q-mr-xs"},ze={key:1,style:{"text-decoration":"line-through"},class:"text-grey-5 q-mr-xs"},Le={key:0,class:"row"},je="works",Re={__name:"WorkDialog",props:P({work:Object,seriesOptions:Array},{modelValue:{},modelModifiers:{}}),emits:P(["close"],["update:modelValue"]),setup(g,{emit:S}){const y=se(g,"modelValue"),c=g,D=S,k=W(),b=ye("fileAgent"),{handleSubmit:f,resetForm:U,isSubmitting:h}=$e({validationSchema:Ae({name:Y().required("作品標題是必填的").max(100,"作品標題最多只能有 100 個字元"),category:Y().required("分類是必填的").test("is-valid-category","請選擇有效的分類",function(r){return c.seriesOptions.some(e=>e.value===r)}),content:Y().max(500,"內容最多只能有 500 個字元"),post:qe().required("是否張貼是必填的")}),initialValues:{name:"",category:"",content:"",post:!1}}),_=R("name"),Q=R("category"),n=R("content"),o=R("post"),i=v([]),N=v({views:0,likes:[]}),s=v([]),m=v([]),t=v([]),x=v([]),H=v([]),L=v([]),I=v([]);J(y,r=>{r&&!c.work&&(i.value=[],N.value={views:0,likes:[]},t.value=[],x.value=[],X())}),J(()=>c.work,r=>{r&&(_.value.value=r.name,Q.value.value=r.category._id,i.value=r.tags,n.value.value=r.content,o.value.value=r.post,N.value.value=r.statistics,t.value=[...r.images],x.value=[],X())});const pe=f(async r=>{if(s.value.some(e=>e.error)){k.notify({type:"negative",message:"請選擇有效的圖片檔案"});return}if(!c.work&&s.value.length===0){k.dialog({title:"錯誤",message:"請上傳作品圖片"});return}if(c.work?.images.length+s?.value.length>5){k.dialog({title:"錯誤",message:`最多只能再上傳 ${5-c.work.images.length} 張圖片`});return}try{const e=new FormData;e.append("name",r.name),e.append("category",r.category),e.append("tags",JSON.stringify(I.value)),e.append("content",r.content),e.append("post",r.post),e.append("folder",je),e.append("deletedImages",JSON.stringify(x.value)),s.value.length>0&&s.value.filter(M=>M.file).map(M=>M.file).forEach(M=>{e.append("images",M)});const{data:B}=await(c.work?Z.update(c.work._id,e):Z.create(e));k.notify({type:"positive",message:c.work?"作品更新成功":"作品新增成功"}),le(B.work)}catch(e){console.error(e),k.notify({type:"negative",message:e?.response?.data?.message||"操作失敗，請稍後再試"})}}),le=r=>{U(),b.value.deleteFileRecord(),s.value=[],m.value=[],D("close",r)},ve=r=>{x.value.push(t.value[r]),t.value.splice(r,1)},X=async()=>{I.value=[],L.value=[],H.value=[];try{const{data:r}=await ce.getAll();H.value=r.tags,console.log("獲取標籤列表"),L.value=r.tags.map(e=>({value:e._id,label:e.name,enable:e.enable,color:e.enable?"primary":"grey"})),I.value=L.value.filter(e=>i.value.some(B=>B._id===e.value)).map(e=>e.value)}catch(r){console.error("獲取標籤失敗",r)}},j=v(!1),ge=()=>{j.value=!0},fe=()=>{j.value=!1,console.log("重新獲取標籤列表"),X()};return(r,e)=>{const B=be("VueFileAgent");return p(),C(ue,{modelValue:y.value,"onUpdate:modelValue":e[9]||(e[9]=u=>y.value=u),persistent:""},{default:a(()=>[l(ne,{class:"q-pa-md",style:{"min-width":"400px"}},{default:a(()=>[l(Se,{onSubmit:we(d(pe),["prevent"])},{default:a(()=>[l(O,null,{default:a(()=>[w("div",Ie,A(c.work?"編輯作品":"新增作品"),1)]),_:1}),l(O,{class:"q-gutter-md"},{default:a(()=>[l(z,{modelValue:d(_).value.value,"onUpdate:modelValue":e[0]||(e[0]=u=>d(_).value.value=u),deleteable:"",disable:d(h),error:!!d(_).errorMessage.value,"error-message":d(_).errorMessage.value,label:"標題"},null,8,["modelValue","disable","error","error-message"]),l(de,{label:"分類",modelValue:d(Q).value.value,"onUpdate:modelValue":e[1]||(e[1]=u=>d(Q).value.value=u),disable:d(h),options:c.seriesOptions,"option-value":"value","option-label":"label","emit-value":"","map-options":"",error:!!d(Q).errorMessage.value,"error-message":d(Q).errorMessage.value},null,8,["modelValue","disable","options","error","error-message"]),w("div",Be,[w("div",Ee,[e[10]||(e[10]=w("div",{class:"text-subtitle1 text-grey-7"},"標籤",-1)),l(V,{class:"q-mb-xs",color:"primary",size:"sm",dense:"",outline:"",icon:"edit",onClick:ge})]),l(ke,{options:L.value,type:"checkbox",modelValue:I.value,"onUpdate:modelValue":e[2]||(e[2]=u=>I.value=u),inline:"",dense:""},{label:a(u=>[u.enable?(p(),$("span",Oe,A(u.label),1)):(p(),$("span",ze,A(u.label),1))]),_:1},8,["options","modelValue"])]),l(z,{modelValue:d(n).value.value,"onUpdate:modelValue":e[3]||(e[3]=u=>d(n).value.value=u),disable:d(h),error:!!d(n).errorMessage.value,"error-message":d(n).errorMessage.value,label:"內容",type:"textarea",outlined:""},null,8,["modelValue","disable","error","error-message"]),t.value.length>0?(p(),$("div",Le,[(p(!0),$(G,null,ee(t.value,(u,M)=>(p(),$("div",{key:M,class:"image-container",style:{position:"relative",width:"20%"}},[l(me,{src:u,style:{width:"100%"},alt:u},null,8,["src","alt"]),l(V,{round:"",dense:"",icon:"close",color:"negative",class:"delete-btn",size:"8px",onClick:Xe=>ve(M)},null,8,["onClick"])]))),128))])):E("",!0),l(B,{ref_key:"fileAgent",ref:b,modelValue:s.value,"onUpdate:modelValue":e[4]||(e[4]=u=>s.value=u),"raw-model-value":m.value,"onUpdate:rawModelValue":e[5]||(e[5]=u=>m.value=u),accept:"image/jpeg,image/png",deletable:"",disable:d(h),"error-text":{type:"檔案格式不正確",size:"檔案大小不得超過 5MB"},"help-text":"選擇或拖拽檔案",multiple:!0,maxFiles:5,"max-size":"5MB"},null,8,["modelValue","raw-model-value","disable"]),l(re,{label:d(o).value.value?"張貼中":"未張貼",modelValue:d(o).value.value,"onUpdate:modelValue":e[6]||(e[6]=u=>d(o).value.value=u),disable:d(h),error:!!d(o).errorMessage.value,"error-message":d(o).errorMessage.value},null,8,["label","modelValue","disable","error","error-message"]),l(ie,{align:"right"},{default:a(()=>[l(V,{color:"secondary",onClick:e[7]||(e[7]=u=>le(!1))},{default:a(()=>e[11]||(e[11]=[F("取消",-1)])),_:1,__:[11]}),l(V,{type:"submit",loading:d(h),color:"primary"},{default:a(()=>[F(A(c.work?"更新":"新增"),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1}),l(Fe,{modelValue:j.value,"onUpdate:modelValue":e[8]||(e[8]=u=>j.value=u),tags:H.value,onClose:fe},null,8,["modelValue","tags"])]),_:1},8,["modelValue"])}}},Ke=Ue(Re,[["__scopeId","data-v-60beed41"]]),Pe={style:{"overflow-x":"auto","max-width":"100%"}},Je={style:{display:"flex","align-items":"center",gap:"8px"}},Ge={key:0,class:"row q-gutter-xs",style:{width:"150px"}},He={style:{width:"200px",height:"100px","overflow-y":"auto","white-space":"pre-line"}},pl={__name:"WorksPage",setup(g){const S=v([]),y=v(""),c=v(null),D=v([]);(async()=>{try{const{data:s}=await Ce.getAll();D.value=s.series.map(m=>({label:m.name,value:m._id})),console.log("獲取作品系列列表",D.value)}catch(s){console.error("獲取作品系列列表失敗",s)}})();const b=Ve(()=>S.value.filter(s=>{const m=!y.value||s.name.toLowerCase().includes(y.value.toLowerCase()),t=!c.value||s.category._id===c.value;return m&&t})),f=v({page:1,rowsPerPage:5});J([y,c],()=>{f.value.page=1});const U=W(),h=[{name:"action",label:"操作",field:"action"},{name:"post",label:"發佈",field:"post"},{name:"name",label:"名稱",field:"name",align:"left",sortable:!0},{name:"images",label:"圖片",field:"images",align:"center",sortable:!1},{name:"category",label:"分類",field:s=>s.category.name},{name:"tags",label:"標籤",field:s=>s.tags.join(", "),align:"left"},{name:"content",label:"內容",field:"content"},{name:"statistics",label:"統計",field:"statistics"},{name:"createdAt",label:"建立日期",field:s=>new Date(s.createdAt).toLocaleString(),sortable:!0},{name:"updatedAt",label:"更新日期",field:s=>new Date(s.updatedAt).toLocaleString(),sortable:!0}],_=async()=>{try{console.log("獲取作品列表");const{data:s}=await Z.getAll();S.value=s.works}catch(s){console.error("Error fetching works:",s),U.notify({type:"negative",message:"無法載入作品資料"})}};_();const Q=s=>{U.dialog({title:"所有圖片",message:s.map(m=>`<img src="${m}" style="width: 100%; margin-bottom: 8px;" />`).join(""),html:!0})},n=v(!1),o=v(null),i=s=>{o.value=s,n.value=!0},N=()=>{_(),n.value=!1,o.value=null};return(s,m)=>(p(),C(Qe,{class:"flex flex-center"},{default:a(()=>[w("div",Pe,[l(_e,{separator:"cell",rows:b.value,columns:h,"row-key":"id",class:"q-table--dense",pagination:f.value,"onUpdate:pagination":m[3]||(m[3]=t=>f.value=t)},{top:a(()=>[l(he,null,{default:a(()=>[l(V,{flat:"",icon:"add",label:"新增作品",onClick:m[0]||(m[0]=t=>i(null)),class:"q-mr-sm"}),l(xe),l(z,{modelValue:y.value,"onUpdate:modelValue":m[1]||(m[1]=t=>y.value=t),dense:"",outlined:"",clearable:"",placeholder:"搜尋名稱"},{prepend:a(()=>[l(K,{name:"search"})]),_:1},8,["modelValue"]),l(de,{modelValue:c.value,"onUpdate:modelValue":m[2]||(m[2]=t=>c.value=t),dense:"",outlined:"",clearable:"",placeholder:"搜尋分類",options:D.value,"emit-value":"","map-options":""},{prepend:a(()=>[l(K,{name:"filter_list"})]),_:1},8,["modelValue","options"])]),_:1})]),"body-cell-images":a(t=>[l(T,{props:t},{default:a(()=>[w("div",Je,[t.row.images&&t.row.images.length>0?(p(),C(me,{key:0,src:t.row.images[0],style:{width:"100px",height:"100px"},class:"q-ma-sm",alt:t.row.name},null,8,["src","alt"])):E("",!0),t.row.images.length>1?(p(),C(V,{key:1,outline:"",dense:"",label:"更多",onClick:x=>Q(t.row.images)},null,8,["onClick"])):E("",!0)])]),_:2},1032,["props"])]),"body-cell-tags":a(t=>[l(T,{props:t},{default:a(()=>[t.row.tags.length>0?(p(),$("div",Ge,[(p(!0),$(G,null,ee(t.row.tags,x=>(p(),$(G,{key:x._id},[x.enable?(p(),C(te,{key:0,color:"primary",class:"q-mr-xs"},{default:a(()=>[F(A(x.name),1)]),_:2},1024)):(p(),C(te,{key:1,color:"grey",style:{"text-decoration":"line-through"},class:"q-mr-xs",outline:""},{default:a(()=>[F(A(x.name),1)]),_:2},1024))],64))),128))])):E("",!0)]),_:2},1032,["props"])]),"body-cell-content":a(t=>[l(T,{props:t},{default:a(()=>[w("div",He,A(t.row.content),1)]),_:2},1032,["props"])]),"body-cell-post":a(t=>[l(T,{props:t},{default:a(()=>[t.row.post?(p(),C(K,{key:0,name:"check",size:"md",color:"green"})):E("",!0)]),_:2},1032,["props"])]),"body-cell-statistics":a(t=>[l(T,{props:t},{default:a(()=>[w("div",null,[w("div",null,"瀏覽次數: "+A(t.row.statistics.views),1),w("div",null,"喜歡人數: "+A(t.row.statistics.likes.length),1)])]),_:2},1032,["props"])]),"body-cell-action":a(t=>[l(T,{props:t},{default:a(()=>[l(V,{flat:"",icon:"edit",onClick:x=>i(t.row)},null,8,["onClick"])]),_:2},1032,["props"])]),_:1},8,["rows","pagination"])]),l(Ke,{modelValue:n.value,"onUpdate:modelValue":m[4]||(m[4]=t=>n.value=t),work:o.value,"series-options":D.value,onClose:N},null,8,["modelValue","work","series-options"])]),_:1}))}};export{pl as default};
